<!DOCTYPE html>
<html>
<head>
    <title>Comprobar Ubicacion</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            background: lightgrey;
            text-align: -webkit-center;
            height: 100%;
        }
        .container {
            width: 100vh;
            height: 85vh;
            background-color: gray;
            display: flex;
            justify-content: center;
            align-items: center;
        } 
        #map {
            width: calc(100% - 5px);
            height: calc(100% - 5px);
            background-color: lightcoral;
        }
        .toolbar {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        }
        .toolbar button {
            padding: 8px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .toolbar button:hover {
            background: #1976D2;
        }
        .toolbar a {
            display: inline-block;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
            width: 15px;
            height: 15px;
            margin: 5px;
            cursor: pointer;
        }
        .toolbar a:hover {
            background: #f0f0f0;
        }
        .toolbar a img {
            width: inherit;
        }	      
        #semaforo {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: gray; /* Inicialmente gris */
            margin: 10px;
        }
      </style>
</head>
<body>
    <table>
        <tr><td>
            <strong>Latitud:</strong> <span id="latitud"></span>
            <strong>Longitud:</strong> <span id="longitud"></span><br>
        </td><td>
            <div id="semaforo"></div>
        </td><td>
            <div id="count">0</div>
        </td>
    </tr>
    </table>
    <div class="container">
        <div id="map">
            <div class="toolbar">
                <button id="centrarMapa" class="btn btn-primary">Centrar</button>
                <button id="dibujarAreaDedo" class="btn btn-info">Área (Dedo)</button>
                <button id="dibujarAreaPuntos" class="btn btn-info">Área (Puntos)</button>
                <button id="finalizarEdicion" class="btn btn-success" disabled>Termina</button>                
                <a id="borrarArea" href="#" role="button"><img src="./img/ico-green-eraser.png" alt="Clear Trail"></a>    
            </div>
        </div>    
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([0, 0], 2); // Coordenadas iniciales y zoom
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var userMarker = L.marker([0, 0]).addTo(map);
        var drawnItems = new L.FeatureGroup(); // Grupo para las áreas dibujadas
        map.addLayer(drawnItems);

        var drawing = false;
        var areaPoints = [];
        var areaPolygon = null;
        var areaLine = null;
        var mapMovable = true;
        var drawingMode = 'DEDO'; // DEDO | PUNTOS

        var latitudSpan = document.getElementById('latitud');
        var longitudSpan = document.getElementById('longitud');
        var semaforo = document.getElementById('semaforo');
        var centrarMapaButton = document.getElementById('centrarMapa');
        var dibujarAreaDedoButton = document.getElementById('dibujarAreaDedo');
        var dibujarAreaPuntosButton = document.getElementById('dibujarAreaPuntos');
        var finalizarEdicionButton = document.getElementById('finalizarEdicion');
        var borrarAreaButton = document.getElementById('borrarArea');

        function updateLocation(lat, lng) {
            latitudSpan.textContent = lat;
            longitudSpan.textContent = lng;
            userMarker.setLatLng([lat, lng]);
            checkLocation();
        }

        function checkLocation() {
            if (userMarker && areaPolygon) {
                if (areaPolygon.getBounds().contains(userMarker.getLatLng())) {
                    semaforo.style.backgroundColor = 'green';
                } else {
                    semaforo.style.backgroundColor = 'red';
                }
            }
        }

        function resetDrawing() {
            drawing = false;
            map.dragging.enable(); // Permitir mover el mapa
            mapMovable = true;
            areaPoints = [];
            if (areaLine) {
                map.removeLayer(areaLine);
                areaLine = null;
            }
            finalizarEdicionButton.disabled = true;
        }

        function finishArea() {
            if (areaPoints.length > 2) {
                // Cerrar el polígono
                if (drawingMode === 'DEDO') {
                    areaPoints.push(areaPoints[0]);
                }
                areaPolygon = L.polygon(areaPoints, { color: 'red' }).addTo(drawnItems);
            }
            resetDrawing();
        }

        centrarMapaButton.addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    map.setView([position.coords.latitude, position.coords.longitude], 15);
                }, function(error) {
                    alert("Error al obtener la ubicación: " + error.message);
                });
            } else {
                alert("Geolocalización no soportada por este navegador.");
            }
        });

        dibujarAreaDedoButton.addEventListener('click', function() {
            drawingMode = 'DEDO';
            drawing = true;
            map.dragging.disable();
            mapMovable = false; // Impide que el mapa se mueva mientras se dibuja
        });

        dibujarAreaPuntosButton.addEventListener('click', function() {
            drawingMode = 'PUNTOS';
            drawing = true;
            map.dragging.disable();
            mapMovable = false;
            finalizarEdicionButton.disabled = false;
        });

        finalizarEdicionButton.addEventListener('click', function() {
            finishArea();
        });

        borrarAreaButton.addEventListener('click', function() {
            if (areaPolygon) {
                drawnItems.removeLayer(areaPolygon);
                areaPolygon = null;
            }
            semaforo.style.backgroundColor = 'gray';
        });

        map.on('mousedown', function(e) {
            if (drawing && drawingMode === 'DEDO') {
                areaPoints = [e.latlng];
                areaLine = L.polyline([e.latlng], { color: 'red', weight: 3 }).addTo(map);
            }
        });

        map.on('mousemove', function(e) {
            if (drawing && drawingMode === 'DEDO') {
                areaPoints.push(e.latlng);
                areaLine.setLatLngs(areaPoints);
            }
        });

        map.on('mouseup', function(e) {
            if (drawing && drawingMode === 'DEDO') {
                finishArea();
            }
        });

        map.on('click', function(e) {
            if (drawing && drawingMode === 'PUNTOS') {
                areaPoints.push(e.latlng);
                if (areaLine) {
                    var newPoints = areaLine.getLatLngs();
                    newPoints.push(e.latlng);
                    areaLine.setLatLngs(newPoints);
                } else {
                    areaLine = L.polyline([e.latlng], { color: 'red', weight: 3 }).addTo(map);
                }

            }
        });

        var cnt=0;

        setInterval(function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    var currentCenter = map.getCenter();
                    updateLocation(lat, lng);
                    document.getElementById("count").innerHTML = cnt++;
                    map.setView(currentCenter, map.getZoom(), { animate: false }); 
                }, function(error) {
                    console.error("Error al obtener la ubicación: " + error.message);
                });
            } else {
                console.error("Geolocalización no soportada por este navegador.");
            }
        }, 100);
    </script>
</body>
</html>
